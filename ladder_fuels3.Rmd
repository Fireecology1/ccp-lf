---
title: "cp-lf2023"
author: "DDB Perrakis"
date: "`r Sys.Date()`"
output: word_document
bibliography: references.bib
---

##[Get data]

```{r get.data, include=FALSE}
.libPaths("C:/Dan/RPackages")

knitr::opts_chunk$set(echo = FALSE, root.dir = "c:/Dan/_Remote_projects/ccp_lf/files")

rm(list=ls())
.libPaths("C:/Dan/RPackages")

require(stringr)
require(dplyr)
require(ggplot2)
require(lubridate)

load(file='./mcF.rda')
load(file='./wbmc5.rda')
load(file='./ISI.rda')

#get fd4 from cfi_process
#fd4 <- read.csv('./fire_data_current.csv') %>%
#  mutate(CFI2=factor(CFI, labels=c('Surface', 'Crown')))
fd4 <- read.csv('c:/Dan/_Remote_projects/ccp-lf/files/fire_data_oct2023.csv') %>%  mutate(CFI2=factor(CFI1, labels=c('Surface', 'Crown')))

#Deciduous data
d1 <- read.csv('c:/Dan/_Remote_projects/ccp-lf/files/fire_data_d1_oct2023.csv')

```

##[Create DFs]

```{r create data.frames, include=FALSE}
#Combine conifer data with D1
fd.all <- bind_rows(fd4 %>% select(
  num:RH, Grass.Cure) %>%
    mutate(Date=ymd(Date)), 
  d1 %>% select(num:RH, Grass.Cure) %>%
    mutate(Date=ymd(Date)))  

setwd('c:/Dan/_Remote_projects/ccp-lf')

sharp <- filter(fd4, str_detect(ExpProject, "Sharpsand IM")) %>% pull(num)  #original Sharpsand Immature stands only
sharp.th <- filter(fd4, str_detect(ExpProject, "Sharpsand TH")) %>% pull(num)
sharp.sm <- filter(fd4, str_detect(ExpProject, "Sharpsand SM")) %>% pull(num)

#get sharpsand (IM and TH) stand data
sh.fires0 <- filter(fd4, num %in% c(sharp, sharp.th, sharp.sm)) %>% 
  select(fire, Date, num, ws, MC.SA, MC.SA_dens, MC.SA_season, FMC, 
         FFMC, DMC, ISI, FSG1, SFC, ROS, 
         DC, FWI, CFI1, CFI2, Site) %>%
  mutate(Exp=case_when(
           num %in% sharp ~'Imm',
           num %in% sharp.th ~'Thin',
           num %in% sharp.sm ~'Semi-M' ),
         Plot=str_extract(fire, '\\d+') %>% as.integer) #extract num. from string

sh.fires1 <- mutate(rowwise(sh.fires0), 
                    MC.SA2=wbmc5(ffmc=FFMC, dmc=DMC, stand=4,                                           density=2, season=MC.SA_season)) #MC.SA_dens=2

#alternate isi, using mcSA and wind speed:
isi.mcsa <- function(mc, ws) {
  #m = 147.2*(101-ffmc)/(59.5+ffmc)  #original mc from FFMC (mcF) formula
  f_w = exp(0.05039*ws)
  f_f = (91.9*exp(-0.1386*mc))*(1+(mc^5.31)/(4.93*10^7))
  return(0.208*f_w*f_f)
}


#main dataframe for threshold analysis - Sharpsand fires
sh.fires <- mutate(rowwise(sh.fires1), 
                isi.m=isi.mcsa(mc=MC.SA, ws=ws),
                isi.m2=isi.mcsa(mc=MC.SA2, ws=ws))

```

##[SROS models]
```{r sros, include=FALSE}

#original ccp (2019) sf formula
sros.st <- function(isi) {
  0.6308 + 0.056*isi + 0.0086*isi^2
}


#surface fires
s.fires <- mutate(rowwise(fd.all), 
                  isi.m=isi.mcsa(mc=MC.SA, ws=ws)) %>% #get ISI using MC.SA
  filter(CFI1==0) %>% 
  mutate(FT=as.factor(case_when(
           str_detect(ExpProject, 'D1') ~ 'Decid',
           str_detect(ExpProject, 'Dewdrop') ~ 'PPDF',
           TRUE ~ 'Con'))
         ) %>%
  ungroup() %>% as.data.frame()
 
#Add FBP database C4/C5 missing VW fires
s.miss0 <- data.frame(num=122:125, fire=c('PNFI #1 13 yr ONT', 'PNFI #2 12 yr ONT', 
                                         'PNFI RW #1-41-2', 'Carp Lk PNFI WF QC'),
                     CFI1=0, CFI2='Surface', Fire.type='S', ROS=c(7.6, 4.3, 3, 7.5),
                     SFC=c(1.1, 0.59, 0.6, 0.9), CFC=c(0, 1, 0, 0),
      #Note estimated SFC for 3 of the 4
                     Date=c('1977-05-19', '1976-08-04', '1976-05-10', '1963-07-03') %>% ymd(),
                     ws=c(19, 10, 18, 25), FFMC=c(91.7, 89.9, 90.4, 90.7), 
                     ISI=c(14.2, 7, 11.2, 16.7), DMC=c(57, 26, 20, 45), DC=c(107, 276, 86, 81), 
                     BUI=c(57, 42, 25, 45), 
                     MC.SA_season=c(1, 2, 1, 2), MC.SA_dens=2, MC.SA_stand=4, FT='Con')

#with corrected ISI values for the first two C4 PNFI fires
s.miss <- mutate(rowwise(s.miss0), 
                 MC.SA=wbmc5(FFMC, DMC, MC.SA_stand, MC.SA_dens, MC.SA_season),
                 isi.m=isi.mcsa(mc=MC.SA, ws=ws)) %>%
  as.data.frame() 
  

s.fires2 <- bind_rows(s.fires, s.miss)

#Original unaltered conifer SF only
s.fires.con <- filter(s.fires2, FT!='Decid') 

#conifer-only isi.m^2 ROS model
con.lm <- lm(data=s.fires.con, formula=ROS~I(isi.m^2)-1)

#prediction function for simple lm using isi.m
con.mod <- function(isim) {
  predict(con.lm, newdata=list(isi.m=isim))
}

#Noted - fires with some torching seem to be anomalous
#Exceptions: fires with torching, CFC >1
#except <- filter(s.fires, CFC >0.1)

#show exceptions, other issues
# ggplot(s.fires, aes(x=ISI, y=ROS)) + 
#  geom_point() + geom_point(data=except, shape=21, size=4)

#filter out fires with CFC; somewhat anomalous
#first convert all NA CFC values to 0
s.fires3 <- s.fires2 %>% 
  mutate(CFC=ifelse(is.na(CFC), 0, CFC)) %>%
            filter(CFC <= 0.1)

#convert ROS to presumed cured grass value (half-grass influence)
#Should work for cf=100 and cf=other (e.g. 90%)
c7.fullcuring <- 90  #
fc.cf <- 0.176 +0.02 * (c7.fullcuring-58.8)

s.fires.mod <- s.fires3 %>%
  mutate(CF=ifelse(Grass.Cure > 58.8, 0.176+0.02 * (Grass.Cure-58.8),
                   0.005 * exp(0.061 * Grass.Cure)),
         ROS=ifelse(is.na(Grass.Cure), ROS,
                    ROS+ROS*fc.cf*(1/CF)/2)) #actual ROS plus half of 'full curing' ROS if it was all grass


#surface fires, with false detrended C7; colour by FT
#with isi.m squared model and linear (con.mod)
ggplot(s.fires.mod %>% filter(!is.na(SFC)), 
       aes(x=isi.m, y=ROS)) +  
  geom_point(aes(colour=FT, size=SFC)) +    
  stat_smooth(method=lm, formula=y~I(x^2)-1, 
              se=FALSE, colour='black') +    
#  geom_point(data=s.fires.mod %>% filter(FT=='PDF'), shape=21, size=4) +
  stat_smooth(data=s.fires.con, method=lm, 
              formula=y~x-1, se=FALSE, colour='gray')
#Add dewdrop fires again untransformed

#Shown using ISI:
ggplot(s.fires.mod %>% filter(!is.na(SFC)), 
       aes(x=ISI, y=ROS)) +  
  geom_point(aes(colour=FT, size=SFC)) +    
  stat_smooth(method=lm, formula=y~I(x^2)-1, 
              se=FALSE, colour='black') +    
#  geom_point(data=s.fires.mod %>% filter(FT=='PDF'), shape=21, size=4) +
  stat_smooth(data=s.fires.con, method=lm, 
              formula=y~x-1, se=FALSE, colour='gray') 


#So far these models involve - 
# - Cutting out data with CFC > 1
# - 'Detrending' PIPO fires to simulate 100% grass curing, half
# - including substantial percentage of D1 fires

#linear model using ISI
sros.ISI2.mod <- lm(ROS ~ I(ISI^2)-1, data=s.fires.mod)
#r^2=0.7217 with s.fires3
#r^2=0.690 with s.fires.mod

#lm using isi.m
sros.isim2.mod <- lm(ROS ~ I(isi.m^2)-1, data=s.fires.mod)
#r^2=0.708 with s.fires2
#r^2=0.766 with s.fires.mod

#lm using isi.m AND SFC
sros.isim2SFC.mod <- lm(ROS ~ I(isi.m^2)+SFC-1, data=s.fires.mod)
#r^2=0.749 with s.fires2
#r^2=0.807 with s.fires.mod

#similar model with ISI (sros.ISI2SFC.mod) is also good, but not as good
sros.ISI2SFC.mod <- lm(ROS ~ I(ISI^2)+SFC-1, data=s.fires.mod)
#r^2=0.7407


sros.lin <- function(ws) {
  predict(sros.lin.mod, newdata=list(ws=ws))
}

#redo SF plot with new bivariate model



#first, fake 

#fake data for lines
f.sfires0 <- data.frame(fisim=seq(0:40), fsfc1=1, fsfc2=2)
f.sfires <-mutate(rowwise(f.sfires0),
                       fros1=predict(sros.isim2SFC.mod, 
                                     newdata=list(isi.m=fisim, SFC=fsfc1)),
                       fros2=predict(sros.isim2SFC.mod, 
                                     newdata=list(isi.m=fisim, SFC=fsfc2)))

#sigmoidal curve like FBP; try c6s to start
#then vary b and c params
c6s <- function(isi) {
  ros=30 * (1-exp(-0.08*isi))^3
  return(ros)
}

s.nls <- nls(data=s.fires.mod, formula=
               ROS ~ 25 * (1-exp(-b*isi.m))^c, start=list(b=0.08, c=3))
#just need to make a function

#plotted data and best model:
ggplot(s.fires.mod %>% filter(!is.na(SFC)), 
       aes(x=isi.m, y=ROS)) +  
  geom_point(aes(colour=FT, size=SFC)) +    
  #geom_point(data=s.fires.mod %>% filter(FT=='PDF'), shape=21, size=4) +
  geom_line(data=f.sfires, aes(x=fisim, y=fros1), colour='gray') +
  stat_function(fun)
  


  

```

##[VW.lf mods]

```{r vw.lf mods, include=FALSE}
#Vw crown fire model-critical SFC
vw.sfc <- function(fmc=100, z, ros) {
  h = 460+25.9 * fmc
  I_0 = (0.01*h*z)^1.5
  #return(I_0)
  #Byram59
  sfc_0 = I_0/(300*ros)
  return(sfc_0)
  #critical sfc for crowning
  #use ros from surface ros model (VW or Perrakis 2020)
}

#VW model - critical intensity
vwi <- function(fmc=100, z) {
  h = 460+25.9 * fmc
  I_0 = (0.01*h*z)^1.5
  return(I_0)
}

#ladder fuel scaling
#Corrected!
lf.sfc <- function(zg, zl, fcl) {
  #zg is overstory LCBH
  #zl is ladder fuel height, or understory fuel centroid
  fcg=(zg/(zg-zl))^1.5 * fcl
  return(fcg)
}

#write.csv(lf.sfc, file='c:/Dan/_Fire_tools/r_scripts_functions/lf-sfc.rda')

sros.vw <- function(isi) {
 20*(1-exp(-0.2*isi))^5 
}

#Assume Sharpsand FSG ~ 4.5 m
#Snag height ~ 3.2 m
#with crown ratio of 0.5, dead CBH=1.6m, centroid = 3.2-(3.2 * 0.5 * 0.5)= 
zl.test = 4.5-3.2+(3.2 * 0.5 * 0.5)  #FSG_L



```


## Analysis

### #Sharpsand histograms with 3 treatments - hide

```{r Sharpsand Histograms}
scalex <- seq(2, 22, by=2)

#graph with histograms: ISI
sh.lad.histo <- ggplot(sh.fires, aes(x=ISI)) + 
  geom_histogram(binwidth=1, aes(fill=CFI2)) + 
  facet_grid(Exp~.) +
  scale_x_continuous(breaks=scalex) +
  theme_classic() +
  scale_fill_manual(values=c("#00AFBB", "#FC4E07")) +
  labs(title='Crown fire thresholds, Sharpsand Ck:ISI')

sh.lad.histo

#graph with histo: isi.m (mc.sa-based ISI, using season, density, DMC)
sh.lad.histo2 <- ggplot(sh.fires, aes(x=isi.m)) + 
  geom_histogram(binwidth=1, aes(fill=CFI2)) + 
  facet_grid(Exp~.) +
  scale_x_continuous(breaks=scalex) +
  theme_classic() +
  scale_fill_manual(values=c("#00AFBB", "#FC4E07")) +
  labs(title='Crown fire thresholds, Sharpsand Ck: ISI.mcsa')

#sh.lad.histo2
```

Crown fire thresholds for the 3 Sharpsand Creek stand structures are
shown in Figure 2. Both the site factor and ISI were significant
(alpha=0.05) in predicting crown fire occurrence.

Tried pooling sites together; probably not much there.

### #Pooling SM and TH, new histogram - hide

```{r Pooling thinned and semi-m trts}
fires3 <- mutate(fires2, 
                 Exp.pool = case_when(
                   Exp=='Imm' ~ 'Imm',
                   TRUE ~'Th and SM'
                 ))

#graph with pooled treatments, ISI
sh.lad.histo3 <- ggplot(fires3, aes(x=ISI)) + 
  geom_histogram(binwidth=1, aes(fill=CFI2)) + 
  facet_grid(Exp.pool~.) +
  scale_x_continuous(breaks=scalex) +
  theme_classic() +
  scale_fill_manual(values=c("#00AFBB", "#FC4E07")) +
  labs(title='Crown fire thresholds, Sharpsand Ck: ISI, pooled')

sh.lad.histo3
```

### #Logistic regression of stand types (treatments), ISI

```{r Define CFI models for SH stands}
fires.stat <- select(sh.fires, CFI1, CFI2, FFMC, ws, SFC, 
                     MC.SA, ISI, Exp, isi.m, isi.m2) %>%
  ungroup()
#%>%  mutate(CFI2=as.numeric(CFI2))

sh.mod <- glm(CFI1 ~ ISI + Exp, data=fires.stat, family='binomial') #base model, ISI and treatment; both sig. at alpha=0.05

sh.mod2 <- glm(CFI1 ~ isi.m + Exp, data=fires.stat, family='binomial') #ISI using MC.SA, density 2 for TH, 3 for others. Works! p < 0.05 for all

####OK - make sure to change Sharpsand 'partly thinned' plot to MC.SA_dens==3



#Use sh.mod (ISI) for log. regression graph
#Use both for threshold values

#graph with jittered scatter plot
#Isi.seq <- seq(4, 20, by=0.1)

#which model to use? sh.mod with ISI or sh.mod2 with mc.sa or other
use.mod <- sh.mod
#use.mod <- sh.mod2

#generate fake data for log. regression graphs
fdata.IM <- data.frame(fISI=seq(3, 20, by=0.1), fExp='Imm') %>%
  mutate(CFI=predict.glm(use.mod, newdata=list(ISI=fISI, Exp=fExp), 
                         type='response'))
fdata.SM <- data.frame(fISI=seq(3, 20, by=0.1), fExp='Semi-M') %>%
  mutate(CFI=predict.glm(use.mod, newdata=list(ISI=fISI, Exp=fExp), 
                         type='response'))
fdata.TH <- data.frame(fISI=seq(3, 20, by=0.1), fExp='Thin') %>%
  mutate(CFI=predict.glm(use.mod, newdata=list(ISI=fISI, Exp=fExp), 
                         type='response'))

mod.co<-use.mod$coefficients

#solve for p=0.5 in logistical function; 
#p=exp(b0+b1*ISI+b2*ExpSemi-M+b3*ExpThin+c)
#so 0.5=1/(1+exp(b0+b1*ISI+b2*ExpSemi-M+b3*ExpThin+c)
#2=1+exp(b0...)
#1=exp()
#0=b0+b1*ISI+b2*ExpSemi-M+b3*ExpThin+c
#ISI=(b0+b2*ExpSemi-M+b3*ExpThin)/b1

summary(use.mod)  #
```

Based on the logistic regression model, ISI and treatment were both
significant determiners of crown fire success, although the only
significant treatment difference was between immature and thinned
stands.

### #Log. regression graph, scaling models, vw model

```{r ISI-CFI graph, define functions}
#Main ISI-CFI graph with jittered data

sh.isi.log <- 
  ggplot(fires.stat, aes(y=CFI1, x=isi.m))+
  #scale_shape_manual(values=c(23, 22, 21)) +   #pick nice shapes 
  theme_classic() +
  scale_fill_manual(values=c('red', 'green', 'blue'))+
  scale_shape_manual(values=c(21, 23)) + 
  geom_jitter(aes(fill=Exp, colour=Exp, shape=CFI2), 
              size=2.5, width=0, height = 0.02, alpha=0.4) +  
  geom_line(data=fdata.IM, aes(x=fISI, y=CFI), colour='red') +
  geom_line(data=fdata.SM, aes(x=fISI, y=CFI), colour='green') +
  geom_line(data=fdata.TH, aes(x=fISI, y=CFI), colour='light blue') +
  labs(x='ISI', y='p(CFO)') #+
#  annotate('segment', x=isi.thresh.imm(), xend=isi.thresh.imm(), 
#           y=0.4, yend=0.6, alpha=0.4, colour='red') +
#  annotate('segment', x=isi.thresh.th(), xend=isi.thresh.th(), 
#           y=0.4, yend=0.6, alpha=0.6, colour='light blue') 
  
sh.isi.log

#Solve for I0 with vw77? 
#Turn difference in threshold ISI into I0
#use surface fire spread model
#solve for ROS_0



```

### #Crowning thresholds by treatment

```{r cf thresholds}
#get cf thresholds
isi.thresh.imm <- function(Exp=Imm) { #Imm (NA), Semi-M, or Thin
  isi=-(mod.co[[1]])/mod.co[[2]]
  return(isi)
}

isi.thresh.th <- function(Exp=Thin) { #Imm (NA), Semi-M, or Thin
  isi=-(mod.co[[1]] + mod.co[[4]])/mod.co[[2]]
  return(isi)
}

isi.thresh.semiM <- function(Exp=Semi.M) { #Imm (NA), Semi-M, or Thin
  isi=-(mod.co[[1]] + mod.co[[3]])/mod.co[[2]]
  return(isi)
}


#thresholds with ISI (sh.mod):
#imm: 6.61
#th: 10.31

#thresholds with ISI.mcsa (sh.mod2):
#imm: 4.70
#th: 9.19

#'working mean':
#'imm': 6.3
#'th': 9.8

```

##Solving for M, the ladder fuel multiplier


We will work with the Immature and Thinned crown fire thresholds to solve for M, using a range of techniques, including expert opinion, comparing critical intensity for crowning between both stands, and the fitted ROS models.     

The first method involves expert opinion. Cruz et al. [-@cruz2004] noted that the different stand structures between the IM and TH stands amounted to a difference in fuel strata gap of 2 m. They used 4 m for the TH stand and 2 m for the IM stand. We will use this as well as the values derived from the more precise estimates from original stand data [@walker1975] of 4.45 m (TH) and 4.36 m (IM). Using equation 6, we get $$\begin{aligned} 
M 
&=(\frac{4.45}{(4.45-2.36)})^{1.5} \\
M&=3.107 \end{aligned}$$ 

Second method: fitting M to empirical CFO model
We will refit the crown fire occurrence database, previously described in Perrakis et al. [@perrakis2023]. This time, in addition to the b_n coefficients, we will fit M, the ladder fuels multiplier, applied to FC_G values as a random variable. This includes testing the upper canopy crowning at the two sites with two-layered canopies (Kenshoe Lake and ICFME; [@perrakis2023]). 

For the third estimation method, we will test M using Byram's I_0 thresholds applied to the portion of the experimental fire dataset representing the Sharpsand Creek fires. This site, with many fires in stands that differ primarily by age and treatment, provides the ideal test case for fitting a ladder fuel multiplier. 

Work with thresholds:

Immature ISI: `r isi.thresh.imm()` #6.61
Immature, ISI.mcsa: #4.70`

Thinned, ISI: `r isi.thresh.th()` #10.31
Thinned, ISI.mcsa: #9.80

Semi-mature, ISI: `r isi.thresh.semiM()` #8.62
SM, ISI.mcsa: #8.95


[Delete? At mean WS_10 of 12.3 km /h, the IM threshold works out to FFMC of
about 88.7 and TH threshold is about FFMC 91.8. Using the MC.SA-based models and the same wind speed, the IM and TH thresholds work out to MC.SA values of 14.8 and 9.8, respectively.  ]

Third method: Byram's I_0 with empirically-derived crowning thresholds. 
Using Byram's [-@Byram1959] equation, we will use I_0 along with the two empirically-derived threshold ISI values for CFI to calibrate the SFC multiplier for ladder fuel consumption:

$$I_{0}=h \cdot SFC_0 \cdot ROS$$
We will use the FBP System conventions for units and constants: I~0~ in kW m\^{-1}, SFC in kg m\^{-2}, ROS in m min\^{-1}, and h=18,000 kJ kg\^{-1}; to convert ROS to m s\^{-1}, we multiply by the constant 1 min/60 s  [@FCFDG 1992]. We assume that the LCBH of both the Immature and Thinned stands are, for working purposes, both identical at about 4.4 m, since the experimental stands were located at the same site and differed only (to our knowledge) in the thinning treatment conducted ~15-20 years prior to burning. This is in line with a recent crown fire analysis estimating LCBH for both stands at 4.4-4.5 m [@perrakis2023] as well as previous studies using these data that characterized LCBH as identical (4 m) in both stand types [@stocks1987; @vanwagner1993; @FCFDG1992; @cruz2004]. Therefore, the critical surface fire intensity for engaging the 4.4 m LCBH canopy fuels, once the ladder fuels are accounted for, should be comparable. We will also assume that a similar sROS model could be used in both stands, though we will discuss and evaluate this assumption later. 

If $h$ is the same in both stands, then 
$$ ROS_{0.IM} \cdot SFC_{0.IM}=ROS_{0.TH} \cdot SFC_{0.TH}$$

In the IM stand, with mean SFC of 1.41 kg/m\^2, the crowning threshold was ISI `r isi.thresh.imm()` #6.61 or ISI.m #4.70. With a dead stem mean height of 3.49 m, the ladder fuel centroid $C_L=$ 1.75 m, and $z-z_L=$ 2.62 m. Ladder fuel consumption, based on the loading of \< 1 cm dead roundwood [@stocks1987], was estimated at 0.159 kg/m2. Using equation 6, this scales to FC~G~= 0.3392 kg m\^{-2}. We now define the final SFC value including ladder fuels scaled to the ground as the effective SFC, where $SFC_e=SFC + FC_G \cdot M$ (actual SFC plus scaled-to-ground ladder fuel consumption times a multiplier). Thus, $SFC_e=1.41 + 0.3392 M$. 

In the TH stand, mean SFC was 1.12 and we assume the remaining dead ladder fuels represented a baseline, negligible effect. 
 
[We will use a simple fitted ROS model based on Canadian experimental fire data, previously presented during the creation of the 'Conifer Pyrometrics' system. This model uses $ISI$ and $ISI^2$ as predictors:
$$ROS_S=0.6308 + 0.056 \cdot ISI + 0.0086 \cdot ISI^2$$ ] Don't use!

[Use isi.mcsa model instead]

Substituting $SFC_e$ for $SFC_{0.IM}$ and solving for $M$ gives the following  algebraic solution:
$$SFC_e=\frac {ROS_{0.TH} \cdot SFC_{0.TH}} {ROS_{0.IM}}$$
and
M=[[ROS_0th . SFC_0TH / ROS_0IM] -1.41]/0.3392

[works with ROS_0 values below....]
$$M=$$

A rearrangement of Byram's (1959) equation using the effective SFC
allows us to solve for M. 
Thus, I=hwr, and we can use the different values of r, the critical ROS for crowning, based on the threshold moisture values from the logistic regression. 
In the thinned stand, we have two SROS models with crowning thresholds as follows:
$ISI.s_0=9.80$ and $ISI_0=10.31$. These compare to the threshold values in the Immature stand: $ISI.s_0=4.70$ and $ISI_0=6.61$. The next step is to use our surface fire models to solve for critical spread rate, $ROS_0$ for both stands. Using the ISI-based model (Figure X), we predict values of $ROS_0=1.640 m\cdot min^{-1}$ and $ROS_0=0.674 m \cdot min^{-1}$ for the TH and IMM stands, respectively. Using Byram's [2?], we can use the mean SFC in the TH stand to identify the critical surface intensity as $I_0=h \cdot SFC \cdot ROS_0$. Using the FBP System standard of $18 MJ \cdot kg^{-1}$, this works out to $I_0=300 \cdot $  


This presentation uses ROS_0, the critical ROS for crowning in a given stand [@vanwagner1993]. We could solve for M using the mean SFC and I_0 attributes for both the TH and IM stands, but
will need to estimate at least one ROS_0 value in order to solve the
equation.


In the thinned stand, we assume that the remaining ladder fuels (with approx. loading of 0.02 kg/m2 < 1 cm dead roundwood) are negligible in this comparison. Given that we are comparing the threshold SFC values in the two stands at the crowning threshold, we equate SFC_e in the Immature stand with SFC_0 in the Thinned stand. Therefore, 
$$SFC_{e(Imm)} = SFC_{0(Th)}$$

$$SFC+FC_G \times M=\frac {I_0}{h \cdot ROS_0}$$

$$M=\frac {\frac {I_0}{h \cdot ROS_0} - SFC}{FC_G}$$ [7], and

Is this key? Use Linear ROS model & ST ROS model and come up with ROS_0 at different ISI values (or ws, given same FFMC?). FC_G is ...###

$$
ROS_0=\frac {I_0}{h \cdot (SFC + FC_G \cdot M)}
$$

[8].

In the SH-TH stand, mean LCBH was 4.45 m and mean SFC was 1.107 kg/m\^2.
The crowning threshold of `r isi.thresh.th()` #10.29 is equivalent to
FFMC 91.79 at overall mean ws of 12.3 km/h. Dead ladder fuel mean height
is 3.47 m, giving a ladder fuel centroid of 1.73 m and $z-z_L=$ 2.72 m
for use with equation 6. Despite the thinning, some dead ladder fuels
remained at time of burning, estimated to be about 1175 s/ha. Using
Stocks' (1987) standing dead fuel load values, the fuel loading of
individual standing dead trees at Sharpsand Creek was between 0.124 kg
and 0.259 kg per stem, with a mean of 0.156 kg. This value applied to
the TH stands gives a mean ladder fuel consumption 1175 ha-1 x 0.156 kg,
or 0.0183 kg/m2. Scaled using equation 6, this contributes the
equivalent of $FC_G=(4.45/(4.45-1.73))^{1.5} \cdot 0.0183$ or 0.0384
kg/m2 to the effective SFC, SFC_e. Total effective SFC
$SFC_e=SFC+FC_G \times M$ [9], = 1.107 + 0.0384 *M*, where *M* is the
ladder fuel multiplier.

Some quantity of dead snags and ladder fuels are present in every stand,
but 1175 ha-1 may be above the threshold where such fuels are
influential in the crowning process. Perrakis et al. [@perrakis2023]
suggested that \> 1000 ha-1 of small-diameter snags could potentially be
influential in typical Canadian boreal and sub-boreal crown fires, but
250 ha-1 [@lawson1972] was below the threshold for inclusion. With the
estimate for M given above (2.59), we could start by examining values
between 1 (no multiplier effect) and 5, for instance. Given the small
amount of ladder fuel present in the TH stand (FC_G=0.0384 kg m-2), this
allows us to critically evaluate potential M values.

Using equation 1, at FMC=102% and z=4.45 m, $I_0$=1622 kW/m. With M=1 to
5, equation 9 gives a range for SFC_e of 1.1454 to 1.299 kg m-2. At the
approximate heat of combustion for conifer fuel of 18,000 kJ/kg
[@fcfdg1992], equation 8 gives ROS_0 between 4.16 and 4.72 m min-1.
These values are consistent with the observed ROS of the surface fires
in thinned stands, which were between 1.0 and 3.6 m min-1. Although we
are no further ahead in a more precise value for M, it is encouraging
that the observed experimental data match the theoretical relationships.

Another way to estimate M would be to compare with empirical models.

Use Perrakis et al. [@perrakis2023] to estimate M.

Use Model 10:

TH: ws=12.3, SFC= value for TH stand (1.107+0.0384), FSG=4.45,
mc=mcF(91.79)=8.961.

p(CFO)=0.80668

If we keep ws the same and increase moisture (decrease FFMC) to reach
the IM threshold ISI of 6.529, we get FFMC=88.61. In the TH stand, this
gives p(CFO)=0.19283.

Using Model 10 to solve for M (it is actually much easier to do this
iteratively), we get p=0.80668 at SFC_e=3.0920, which is reached in the
IM stand at M=4.8584.

At ws=15, the threshold ISI (TH stand) corresponds with FFMC of 90.8366.
Solving for M using Perrakis et al.'s Model 10 then gives
p(CFO)=0.91552, which is reached in the IM stand at M=7.348, giving
SFC_e = 3.9364.

At ws=10, the threshold ISI for TH corresponds with FFMC of 92.6147.
Solving for M using Model 10 then gives p(CFO)=0.58057. However, this
value cannot be reached in the IM stand, as the lower FSG (4.36) and
higher SFC result in higher p(CFO) even without multiplying the ladder
fuel FC_G.

[#delete? Returning to the IM stand, if we estimate we can use this ROS
value along with the slightly lower LCBH for that stand (z=4.36m), where
equation 1 predicts $I_0=1573$ kW m-1, again calculated at FMC=102%.
Using this value for $I_0$, we can use the following equation from
Byram's to derive a second estimate for M, $M_2$ .]

Solve for M:

Both M and ROS_0 are unknown

M=1573/(300\*ROS1) - 1.107)/0.0384

What we are missing here is a surface ROS estimate for the IM stand at
the lower ISI threshold. A simple linear trend between ISI=0, ROS=0 and
the estimated threshold for the thinned stand
($ISI_0=10.29, ROS_0=4.481$ m min-1) yields $ROS_0=2.853$ m min-1 at
$ISI_0=6.53$ for the IM stand. This is also consistent with the IM
surface fires, which had ROS values up to 2.1 m min-1.

Solving equation 7 for the IM stand, with

$I_0=1573$, $ROS_0=2.84$, SFC=1.444, and $FC_G=0.3392-0.0384$ (corrected
to subtract the estimated ladder fuels contribution in the TH stand),
gives $M_2=1.331$.

(#delete? In order to reach the p(CFO)=0.5 threshold, 0.46 is
required.)]

[at ws=12.3, FSG=4.4, and FFMC=88.6, p(CFO) =0.5 at about SFC=1.9.
Actual mean SFC was 1.44. Diff is 0.46 kg /m2. Convert LF to false-SFC
to derive multiplier. Dead HT=3.49m, FC_L=0.159.

zg=4.4, zl=3.49/2, fcl=0.159

FC_G=0.3392; this is the scaled false -SFC. In order to reach threshold,
0.46 is required.

M=0.46/0.3392=1.356]

Therefore, the difference in the p(CFO)=0.5 crowning threshold between
the IM and TH stands, based on the difference between a mean dead s/ha
(10229 vs 1175 s/ha) is equivalent to a difference of about 0.339 kg/m2
vs .038 kg/2 scaled SFC, a nine-fold difference. This is a significant,
but not overwhelming difference in SFC compared with actual mean SFC
values of 1.11-1.44.

Use Perrakis M10 to boost 1.11 to 1.779 (1.444 + 0.339) to get
multiplier.

at ws=12.3, FSG=4.4 and FFMC=91.8, p(CFO)=0.5 at about SFC=0.7. Actual
mean SFC was 1.11. Diff is -0.41 kg/m2. Convert LF to false-SFC to
derive multiplier. Dead HT=3.47, FC_L=0.0406 (based on 2600 s/ha)

zg=4.4, zl=3.47/2, fcl=0.0406

FC_G=0.08613

M=0.41/0.08613

SM:

at ws=12.3, FSG=5.3 and FFMC=90.5, p(CFO)=0.5 at about SFC=1.6. Actual
mean SFC was 2.39\*. Diff is 0.79. Convert LF to false-SFC to derive
multiplier. Dead HT=

\* based on SFC for surface fires only; SFC for all fires is uncertain
and must be estimated, since only TFC is shown.

#See fd_current_process script

Use full ladder fuel CFL, or maybe percentage estimated from ICFME
experiments

We can use equation 6 with the following values:

z_G=4.3

Assume dead ladder fuel is consumed at the stem centroid, H/2

z_L=

## Discussion

As Andrews [-@andrews2018] noted, Rothermel surface model only
applicable to surface fuels, within \~6ft of the ground

Thinning increases sub-canopy turbulence [@russell2018]. See also
Banerjee et al 2020

McAlpine and Xanthopoulos [@mcalpine1989] also noted that C-6s appeared
to overpredict sROS in needle fuelbed experiments. Although they
explained it as a difficulty in estimating

Method could also be used to estimate influence of dead branch fuel
below LCBH, bark flakes, arboreal lichens, or similar material.

```{r get stand data calculate FC_L}
sh.full <- read.csv('c:/Dan/_Remote_projects/ccp_git/ccp-cfi/sharp_full.csv') %>%
  mutate(FSG=LCBH) %>%
  select(-c(X, BA, BA.d, LCBH.L)) %>%
  left_join(fires %>% filter(Exp %in% c('Thin', 'Imm')), by='Plot') %>%
  select(-c(fire, Date, num, DC, FWI, CFI2, Exp)) 

lf.cfl <- c(0.142, 0.073, 0.313, 0.183, 0.133, 0.146, 0.131, 0.131,
              0.176, 0.182, 0.151, 0.218, 0.084) #p11 twice

#crown fuel consumption estimates by fire type
cfc.p <- c(0.39, 0.49, 0.22, 0.46)
cfc.c <- c(0.89, 1.16, 0.99, 1.27, 1.06, 1.4, 1.04, 1.03, 1.11)
cfc.s <- c(0, 0, 0.08, 0, 0)


#* 0.815# using woody consumption? use full CFL here I think; 
#ICFME surface woody consumption was 0.6 (Stocks et al 2004)
#ALso ICFME: Stocks et al (2004): 70-86% of overstory 0-1 cm roundwood were consumed, with moisture contents from 55.5-90.4 % 
#down woody fuel moisture contents were 6.3-14.5 %

#Although P7, 18 (ctrl) and P8, 9, 16 (th) are surface fires, assume dead snags burn
dead.cfc.mean <- mean(lf.cfl)

s.ha.ctrl <- filter(sh.full, TRT=='ctrl') %>% pull(s.ha.d)
dead.cfl.snag <- mean(lf.cfl*10000/s.ha.ctrl)  #mean snag weight cfl (<1 cm) per stem, from ctrl stands; in kg/stem

sh.ctrl <- filter(sh.full, TRT=='ctrl') %>% 
  mutate(cfc.d=lf.cfl,
         cfc.d.stem=cfc.d * 10000/s.ha.d,   #kg/m2*10000 m2/ha/s/ha = kg/stem
         z.l=FSG - HT.D + (HT.D * 0.5 * 0.5),  #assume CR of 0.5;
         sfc.add=cfc.d * (FSG/z.l)^1.5,  #SFC.2=(z.2/z.1)^1.5 * SFC.1
         sfc.add.stem=sfc.add/s.ha.d) 

sh.ctrl2 <- sh.ctrl %>% select(Plot, ISI, FSG, SFC, sfc.add, CFI=CFI1) %>% 
  mutate(sfc.both=SFC+sfc.add)

```

```{r}
#Get surface fires in mod or dense class(exclude GL)

fd.sf <- filter(fd4, CFI1==0 & num != 68 &
#               !num %in% c(sharp, sharp.sm, sharp.th) &
                MC.SA_dens >1) %>% as.data.frame()

#surface fire model, fitted to ISI for all pine mod/dense sf in database (excluding Sharpsand)
sf.mod <- lm(data=fd.sf, formula= ROS ~ I(ISI^2) -1)  #ISI^2 model, forced through 0; looks good
#adj. r^2=0.7207

sf.nl <- nls(data=fd.sf, formula = ROS ~ a + ISI^b, start=list(a=0, b=2))
#Nah - gives b= ~ 0.5, wrong curve shape

#97.5% CI for estimate - not really that good; need 95% for prediction, not param.
#sf98 <- confint.lm(sf.mod, level=0.95)[2] #level=0.8 gives 10% and 90% CI

sf.fun <- function(ISI) {
  sf.mod$coefficients[1]*ISI^2
}


#data for ribbon
ribbon.df <- data.frame(ISI=seq(min(fd.sf$ISI), max(fd.sf$ISI))) %>%
  mutate(ROS=sf.fun(ISI),
         ROS.d35=ROS*0.65, 
         ROS.u35=ROS*1.35)
                        
fd.sf.sharp <- filter(fd.sf, Site %in% c(10:12))  #Sharpsand only

#graph of surface fires, with VW ROS model and fitted ROS model, with ribbon
ggplot(data=fd.sf, aes(x=ISI, y=ROS))+ 
  scale_shape_manual(values=c(2, 5, 6, 0, 1)) +
  geom_point(aes(colour=ExpProject, shape=str_extract(ExpProject, '\\w+'))) +
  geom_point(data=fd.sf.sharp, shape=1, size=4) +
  #geom_point(aes(size=FSG, colour=str_extract(ExpProject, '\\w+'))) + #no not useful in the end
  #geom_smooth(method='lm', formula= 'y~poly(x,2)') +
  geom_ribbon(data=ribbon.df, aes(ymin=ROS.d35, ymax=ROS.u35),
              alpha=0.1) +
  stat_function(fun=ros.vw, colour='grey') +
  stat_function(fun=sf.fun, colour='black') +
  theme_classic() +
  labs(shape='Site') +
  scale_colour_discrete(guide='none') +
  annotate('segment', x=isi.thresh.imm(), xend=isi.thresh.imm(), 
           y=sf.fun(isi.thresh.imm())-1, 
           yend=sf.fun(isi.thresh.imm())+1, colour='red') +
  annotate('segment', x=isi.thresh.th(), xend=isi.thresh.th(), 
           y=sf.fun(isi.thresh.th())-1, 
           yend=sf.fun(isi.thresh.th())+1, colour='blue') +
  geom_text(x=10, y=ros.vw(10)+3, label='VW SF model')

  
```

```{r}
#Mean absolute error - SF model
fd.sf.mae <- mutate(fd.sf, 
                      ROSvw=ros.vw(ISI),
                      ROSsq=sf.fun(ISI),
                      abserr.vw=abs(ROSvw-ROS),
                      abserr.sq=abs(ROSsq-ROS)) %>%
  summarize(mae.vw=mean(abserr.vw),
            mae.sq=mean(abserr.sq))
#mae.vw=4.400
#mae.sq=0.757

#create table of predicted/observed I_0 using vw and new squared ISI model
sh.ctrl2row <- mutate(sh.ctrl2, 
                      Ivw = vw.sfc(fmc=111.5, z=FSG, ros=ros.vw(ISI)),
                      Isq = vw.sfc(fmc=111.5, z=FSG, ros=sf.fun(ISI)))

cfc.dstem <- summarize(sh.ctrl, mean(cfc.d.stem)) %>% pull()#cfc per dead stem, kg

sh.th <- filter(sh.full, TRT=='th') %>% 
  mutate(cfc.d.stem=cfc.dstem, #use cfc in ctrl plots to estimate cfc in th plots
         cfc.d=cfc.d.stem * s.ha.d / 10000, #kg * s/ha / 10000m^2/ha to give kg/m^2
         z.l=FSG - HT.D + (HT.D * 0.5 * 0.5),  #assume CR of 0.5; crown cent. FSG
         sfc.add=cfc.d * (FSG/z.l)^1.5,  #SFC.2=(z.2/z.1)^1.5 * SFC.1
         sfc.add.stem=sfc.add/s.ha.d) 

 sh.th2 <- sh.th %>% select(Plot, ISI, FSG, SFC, sfc.add, CFI) %>% 
  mutate(sfc.both=SFC+sfc.add)

sh.th2row <- mutate(sh.th2, 
                      Ivw = vw.sfc(fmc=111.5, z=FSG, ros=ros.vw(ISI)),
                      Isq = vw.sfc(fmc=111.5, z=FSG, ros=sf.fun(ISI)))

sh.both <- full_join(sh.ctrl2row, sh.th2row) %>%
  mutate(vw.cfi.sf = SFC > Ivw,
         vw.cfi.both = sfc.both > Ivw,
         sq.cfi.both = sfc.both > Isq,
         sfc.m=sfc.add * 3.25 + SFC,
         sq.cfi.m = sfc.m > Isq)
#Threshold ISI fires just enough to get over 50% prob. of CFI
#calc. at mean SFC
```

The problem with a semi-physical assessment of the Sharpsand Creek fires
is that the fundamental relationship appears shaky based on the terms
originally provided. The surface fire model proposed by Van Wagner
[-@vanwagner1993a; 'to define the spread rate of all possible surface
fires'] for immature jack pine fires (i.e. control stands at Sharpsand
Creek) is shown in Figure X to compare with empirical data. The figure
also shows the ISI-ROS relationships for 37 experimental fires from
closed pine stands at various sites across Canada (Supplemental Table
S1). A simple empirical model was fitted to these observations:

$$
ROS_S=0.02214 \cdot ISI^2
$$

[6], with adjusted $R^2$ of 0.706 and mean absolute error (MAE) of
`r  fd.sf.mae[2]`.

This is a much slower surface ROS model than that originally provided,
with scant evidence, by Van Wagner's Equation 5. Although the data shown
in Figure X represents fires from several different sites across Canada,
it strongly suggests that surface fire under a closed pine canopy is
generally much slower than previously suggested. Furthermore, it is now
understood that the surface fuels contributing to an upward heat flux
during flaming combustion in a typical boreal conifer stand are not
comprised of the entire surface fuel layer, but rather only the
well-aerated litter and fine woody debris. These two "errors" were
self-correcting in Van Wagner's original description, but can now be
amended. Instead, if we use the fitted model from Equation 6 to predict
surface ROS at a given ISI value, we are left with much higher required
$SFC_0$ values than observed.

Table X, below, shows the Immature Sharpsand fires, along with estimated
$SFC_L$ calculated from Equation 5.

```{r}
sh.both %>% round(3) %>% 
  mutate(pCFIvw=Ivw)
```

How much of the elevated SFC from ladder fuels was consumed?

The details of partial crowning in a stand are virtually impossible to
predict except probabilistically (e.g. de Groot et al. 2022). A surface
fire moving through a stand is continually affected by wind gusts,
tempered by canopy influence (Moon et al. 2016) and variability in
surface fuelbed properties such as bulk density and loading (ref.
surface fuel var. #Keane?). When a crown fire is involving \< 50% of the
canopy fuels, we might still consider the fire to be a passive (e.g.,
Van Wagner 1993) or intermittent (e.g. FCFDG 1992) crown fire, but
cannot know which elements of the ladder fuel layer will be consumed, or
will result in flame transmission to the live overstory. Such patchy
fire behaviour can be part of fire acceleration from point source
(McAlpine and Wakimoto 1991), but when it is reached under equilibrium
conditions, the upward heat flux from individual ladder fuel elements
(living or dead trees, etc.), clumps or 'jackpots' of surface fuel, etc.
is a probabilistic process. By including and scaling all of the ladder
fuel mass in the $FC_L$, the potential exists to overpredict the ladder
fuel influence, but this

# .
# .

# Headings
# Simple solutions for modelling surface fire and ladder fuels in Canadian conifer forests
Daniel D. B. Perrakis
Dan K. Thompson

##Abstract
Predicting the onset or occurrence of conifer crown fires is an uncertain process. Several operational modelling systems rely on the C.E. Van Wagner (Can. J. For Res. 1977, v7: 23-34) crown fire initiation model derived from simple physical theory and laboratory experiments. Van Wagner's model requires a clear vertical separation between surface and canopy fuel strata, and defines fine-textured biomass located between strata as ladder fuels (LF). While the LF layer contribution to crown fire initiation is not quantified by Van Wagner's model or in most prediction systems, it is suspected to be disproportionately important. In this study, we show how a simple rearranging of Van Wagner's model reframes crown fire initiation as a critical fuel threshold-driven process. A new equation is presented for comparing fuel consumption at different vertical positions in the mid-story, effectively treating LF consumption as though these fuels were lowered to the ground level and boosted in mass. We used fire observations and crown fire thresholds from a well-documented series of experimental burns in Canadian conifer forests to fit simple surface fire models and test the thoretical LF scaling equation. Incorporating LF into empirical crown fire models improved mode results; best results were obtained with a LF multiplier of [??2-3??; draft results], suggesting that LF consumption is about two to three times as influential per unit mass as typical conifer surface fuel consumption. Resulting models will be useful for both first estimates of surface fire spread rate as well as for incorporating LF into separate crown fire models or hazard reduction treatment design. 

##Introduction
Crown fires, CEVW model and ladder fuels; short lit. review (Stephens' papers, lab studies, etc.)
Conifer forests cover most of the circumboreal region of the world and
crown fires represent a significant fire-related hazard in these stands
[@kneeshaw2011, @stocks1991]. As noted by Cruz et al. surface fires
rarely spread \> 6 m/min under closed conifer stands, as higher spread
rates are usually associated with some degree of crowning or torching.
Once flames reach the upper reaches of the canopy, they can be directly
influenced by open lower atmosphere winds; this process has long been
known to be associated with a dramatic increase in spread rate via
several processes including flame tilt and vigorous ember spotting [@cruz2016].

(#delete?) A recent analysis of Canadian experimental burns in boreal and
sub-boreal conifer stands confirmed this, with the 95th percentile ROS
in surface fires only 5 m/min#. Only tall pine stands with no understory
conifer regeneration appeared capable of supporting surface fires under
higher danger conditions.

Stand structure is well-known to influence crown fire occurrence and tendency. The element in fuel complexes that enables crown fires in most tall
conifer stands are ladder fuels. This term refers to any easily-ignited
fuels in the mid-canopy space, meaning fine-textured and flammable dead
or live biomass above the surface fuel complex but below the live canopy
base. In Canada, J.G. Wright first noted that 'crown fires are not
likely to occur unless there is a large volume of fuel under the trees'
[@wright1932]. Van Wagner [@vanwagner1977], in describing his classic
crown fire initiation model based on empirical data and physical
convection theory, noted that such 'bridge fuels' consisted of
'combustible matter such as loose bark, dead lower branches, lichen,
small conifers, etc.' located above the surface fuel complex, remarking
that such fuels needed to be 'present in sufficient quantity to
intensify the surface fire appreciably as well as to extend the flame
height'. While the paper describing Van Wagner's model has been cited become a
classic (> 1500 citations as of 2023), methods for quantifying the effects
of ladder fuels are still lacking 45 years later.

Van Wagner's model was originally formulated to solve for critical
surface intensity ( $I_0$) as follows:

$$
I_0=(chz)^{1.5}
$$

[1],

where $h$ is heat of ignition, $z$ is live crown base height (LCBH), and
$c$ is a dimensional constant derived empirically. Most modelling
systems have expressed $I_0$ using one of the commonly-used flame length
relationships [@alexander2012] combining equation 1 it with Byram's
[-@byram1959] fireline intensity equation in order to solve for critical
rate of spread. This latter combination has allowed for linkages with
Rothermel's [-@rothermel1972] semi-physical surface rate of spread model
[e.g. @scott2001; @andrews2014], or with the empirical ROS functions
from the FBP System fuel types [@forestrycanadafiredangergroup1992].
Surprisingly, a simple algebraic rearranging of the terms of Van
Wagner's model allows for a potentially powerful estimator for varying
vertical position of fuels.


### Objective

The objective of this study was to describe a simple theoretical framework for
analyzing ladder fuel influence in crown fire initiation, based on a rearrangement of Van Wagner's (1977) equation. Secondary objectives include calibrations and evaluations of the theoretical framework, as well as presenting simple surface rate of spread models. The presented theory was By comparing estimated and observed fire behaviour stands with varying ladder fuel densities, we assessed the effectiveness of the theoretical model for improving overall fire behaviour predictions.

##Methods

### Rescaling model: bringing ladder fuel consumption to the surface

Ladder fuels are defined by their fine texture and intermediate vertical position, by definition. They exist in conifer stands between
the surface fuels, at $z=0$, and canopy fuels, which start at the live
canopy base height (LCBH). When connected to the surface fuels and
ignited by a proximate source (i.e. an advancing fireline), their heat
flux contribution is much closer to the canopy base, and therefore much
more likely to contribute to canopy ignition compared to similar fuel
loading at the surface. The structure of the Van Wagner (1977)
CFI model permits a vertical rescaling that relies on an implied equivalency between SFC and the inverse of z (LCBH) in Van Wagner's model.

When we replace $I_0$ (Equation 1) with Byram's (1959) fireline
intensity, we get the following well-known equation (e.g. FCFDG 1992,
Scott and Reinhardt 2001; units omitted for simplicity):

$$
H \cdot SFC \cdot ROS=(c \cdot h)^{1.5} z^{1.5}  
$$[2]

where $H$ is the heat of combustion, $SFC$ is surface fuel consumption,
$ROS$ is rate of forward spread, and the right side is as in Equation 1.

As discussed, this relationship has previously been evaluated in terms
of identifying critical ROS for crown fire initiation (Van Wagner 1977,
Alexander 1988). However, if we assume that surface ROS is insensitive
to moderate variations in LCBH, it should also hold for comparing a
range of SFC values. Under surface fire conditions near the crown fire
initiation threshold, critical SFC could then be defined as follows:

$$
SFC_0=\frac {(ch)^{1.5} z^{1.5}} {h \cdot ROS} 
$$

[3]

Critical SFC for crown fire initiation can then be compared between LCBH
levels, e.g. $z_1$ and $z_2$.

$$
\frac {SFC_2}{SFC_1}=
\frac {  \left[  \frac {(ch)^{1.5} z_2^{1.5}} {h \cdot ROS} \right] } 
{  \left[  \frac {(ch)^{1.5} z_1^{1.5}} {h \cdot ROS} \right] }
$$

[4]

Again, this assumes no change in ROS with varying LCBH. Holding all
other terms constant, we can simplify this to yield a basic relationship
between SFC and LCBH:

$$
SFC_2=(\frac {z_2} {z_1})^{1.5} \cdot SFC_1
$$

[5].

The theoretical relationship can be examined with a logical example, comparing $SFC_0$ at two 
different z values. Using Van Wagner's own empirical heat
of ignition function [@vanwagner1968], at 90% foliar moisture content
(FMC) and LCBH=2 m, Equation 1 suggests $I_0$ of about 417 kW/m, the
intensity of a low to moderate intensity surface fire. At some moderate
surface ROS value, e.g. 3 m/min, Equation 3 gives $SFC_0$ of 0.463
$kg \cdot m^{-2}$. Using Equation 5, increasing LCBH to 5 m without
altering other inputs would raise $SFC_0$ to 1.83 $kg\cdot m^{-2}$ ;
thus, a 2.5 times increase in LCBH would result in a fourfold increase
in fuel consumption needed for crowning, due to the much higher surface
fire intensity required.

In the case of the consumption of an elevated ladder fuel quantity
$FC_L$ positioned at height $z_L$, such as the vertical centroid of
a cohort of standing dead trees, finding the equivalent $SFC$ value at
ground level ($FC_G$) is then a matter of inflating its influence as we
scale it vertically using Equation 5:

$$
FC_G=(\frac {z} {z-z_L})^{1.5} \cdot FC_L ~~, ~~~~~~ z_L > z
$$

[6], where $z$ is the normal (ground-level) LCBH. Aside from Van
Wagner's equation, this is simply a slightly different representation of
Thomas' [-@thomas1963] equation for flame size under calm conditions.
Using Equation 6, it is possible to estimate the contribution of
parts of the fuel complex based on their vertical position in the crown
as if they were part of the surface fuel complex.

We note immediately two fire-related qualifiers. First, this theoretical
relationship does not account for the obvious structural differences
between the surface and crown fuel complexes. In particular, surface
fuelbeds are much more compact (higher bulk density and packing ratio)
than crown fuel complexes, including ladder fuels, with a much more aeration-limited combustion
environment [@keane2015; @schwilk2015]. The general FBP System approach
to SFC, where all consumed surface and ground fuels are assumed to
contribute to surface fire intensity, may also overemphasize dense fuels
that burn in post-frontal combustion [#could use some more references
and discussion on this point]. In contrast, fine crown and ladder fuels
are much better aerated (more porous) but also vertically and
horizontally discontinuous (refs and explanation#). This difference
could be addressed theoretically or, as in the present investigation,
empirically.

Second, while equation 6 specifies that the ladder fuel height cannot
exceed the LCBH, it is apparent that as the difference between them
($z-z_L$) approaches zero, $FC_G$ grows exponentially. Thus, 0.1
$kg \cdot m^{-2}$ of fuel consumption 1 m below a 5 m tall canopy base
is scaled to equate to ground-level SFC of 1.12 $kg \cdot m^{-2}$ , but
the same fuel 0.2 m below the same canopy scales to
$FC_G=12.5~ kg \cdot m^{-2}$. The logic of this holds in a theoretical
sense -- a fire is much more likely to bathe the lower canopy in flame
if the burning fuel is very close below -- but suggests caution is
needed to utilize eq. 6 in a practical sense to avoid inflating the
ladder fuel effect to extreme, and illogical levels.

The remainder of the study tests this relationship with some data from
Canadian experimental fires in conifer stands.

 - Figure showing trees and LF

### Study area: Sharpsand Creek, Ontario

Experiments were initiated in the early 1970's at this site north of
Thessalon, Ontario and revisited over a 30-year period. This resulted in
27 separate and independent experimental fire observations in three
distinct structure classes. The original stand (immature: IM) consisted
of densely stocked jack pine natural regenerated on gravelly soil
[@walker1975a] following the spring 1948 Mississagi fire [@stocks1973].
The dense stands in the earliest burns featured over 9000 live stems/ha
and over 10,000 dead stems/ha as the stand underwent rapid
stem-exclusion. Results from the earlier fires (1975-1981) were
published in Stocks [-@stocks1987a] and included in the empirical
derivation of the C-4 fuel type model [@fcfdg1992]; these were also
analyzed separately by Van Wagner [@vanwagner1993] and discussed in
several other fire behaviour studies [@call1997; @cruz2003; @albini1986,
etc.].

Results from the later fires (1988-1991) were not included in the FBP
System analyses and were fully documented only recently [@mcrae2017a].
The stand characteristics associated with the later experimental fires
highlighted significant structural and successional changes underway as
stands evolved: the dense immature forest was rapidly self-thinning,
from 9,276 live stems/ha at the time of the original experiments
(measured in 1973) to less than half the live density (4,375 stems/ha)
as well as 53% more basal area in 1984. These were termed 'semi-mature'
(SM), and estimated to also have average LCBH of 5.3 m, about 1 m higher
than the IM stands. During the course of the earlier burn experiments,
it was discovered that 6 of the plots had been hand-thinned (TH) in
1960, removing most of the live stems and resulting in much less dense
stands compared with the IM plots [@stocks1987a; B. J. Stocks, personal
communication, Jan. 2020]. While these thinned stands were the same age
and site characteristics as the denser C-4 stands, the burns in the
thinned plots had been deemed more representative of mature pine stands
and previously included in the FBP System C-3 fuel type dataset
[@degroot2022].

As discussed in a previous analysis [@Perrakis2023], earlier studies
handled these three treatments in different ways, but mainly by
estimating the ladder fuel influence as a modification of the LCBH in a
subjective sense, using an expert judgment adjustment (FSG-LCBH-2)
[@cruz2004, @cruz2006, @perrakis2023].

The original stand was naturally regenerated following a 1948 wildfire.
Burning years ranged from in 1974-1976, 1981, 1988, 1990-1991; thus, at
post-fire ages 26-43.

There is a question of which plots experienced crown fire. In the
original Sharpsand experiments (1974-1981; Stocks 1987; Cruz 1999), fire
type was identified as 'surface' or 'crown'. In the latter experiments,
however, fire type was identified as 'surface', 'some torching',
'torching', and 'crown' [@mcrae2017]. Descriptions in the text make it
clear 'torching' fires experienced passive crowning, while those
described as 'some torching' appeared to be near the crowning threshold
(i.e., \~5-15% crown fraction burned). Following discussions with
experimental leaders (BJ Stocks, pers. comm.), the two fires described
as 'some torching' were split, with fire #16 (ISI=8.1, ROS=3.5 m/min)
was considered a surface fire, while fire #18 (ISI=9.4, ROS=5.1 m/min)
was considered a passive crown fire.

Thinned: ISI threshold about 10.2 (above 11.4, all CF; below 10.4 all
SF) =ws17, FFMC90.1; mc.ffmc=10.73

Overall mean SFC 1.3

Solve at ws=12?

The most challenging value for the analysis is the fuel consumption of
ladder fuels, as this is seldom measured (though sometimes estimated
indirectly) in experimental studies. Stocks [-@stocks1987] presented
estimated dead roundwood fuel consumption for the original Sharpsand
Creek exprerimental fires, and these values are used in our analysis.

For the calculations, ladder fuel influence was incorporated into
certain models using equation 6 to scale the fine dead ladder fuels
(snags and dead crown fuel \< 1 cm; Stocks 1987) into an equivalent SFC
contribution value, SFCL. The vertical position of fine standing ladder
fuels was assumed to be the crown centroid of the mean dead snag height
[LCBH+(height-LCBH)/2; @perrakis2023] in an experimental plot (Figure
X#snag diagram). SFCL was then added to the actual (measured) SFC for
modelling. Additional tests were completed where the elevated fuel
contribution was increased using a multiplier, discussed further below.

 
###Validation 1. Use sharpsand Creek treatments and logistic regression
Logistic regression of CFI vs ISI by TRT: CFI ~ ISI + as.factor(Treatment)
 - Test for significant difference between treatments - ok
 - Identify critical ISI threshold: 6.33 and 9.77
 - Use critical ISI threshold to identify LF multiplier; 
 
###Validation 2. Cruz et al. expert opinion (2004: 2 m FSG difference) to estimate  LF multiplier (works out to M=2.59)

###Validation 3. Comparison of CFO models (with LF scaling, with and without multiplier) with Van Wagner's CFI model, using notional Taylor SF model

##Results
##Discussion
 - Figure showing more complex architecture; 2-story stands, using Eq 2 to estimate contribution of surface fuels to upper stratum crowning
 - Validation 4. Upper canopy crowning

